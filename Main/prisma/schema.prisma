// ==============================
// Datasource & Generator
// ==============================
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==============================
// Enums
// ==============================
enum Role {
  ADMIN
  PENELITI
}

// ==============================
// Master
// ==============================
model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  email     String?
  createdAt DateTime @default(now())

  vehicles  Vehicle[]

  @@index([name])
  @@index([email])
}

model Vehicle {
  id                  Int       @id @default(autoincrement())
  customerId          Int
  plate               String    @unique
  brand               String
  model               String?
  year                Int?
  createdAt           DateTime  @default(now())
  serviceIntervalDays Int       @default(180)
  lastReminderEmailAt DateTime?

  customer Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  services ServiceOrder[]
  // opsional: relasi balik ke assignment cluster
  clusterAssignments ClusterAssignment[]  // ← memudahkan include

  // opsional: cache label cluster paling baru, jika mau dipakai di UI / reminder cepat
  cachedClusterIdx   Int?
  clusterUpdatedAt   DateTime?

  @@index([customerId])
  @@index([plate])
  @@index([cachedClusterIdx])
}

model Mechanic {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  active Boolean @default(true)

  services ServiceOrder[]
}

model Part {
  id        Int      @id @default(autoincrement())
  sku       String?  @unique
  name      String
  price     Float    @default(0)
  createdAt DateTime @default(now())

  usages ServicePart[]

  @@index([name])
}

// ==============================
// Detail
// ==============================
model ServiceItem {
  id             Int    @id @default(autoincrement())
  serviceOrderId Int
  name           String
  price          Float  @default(0)

  order ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
}

model ServicePart {
  id             Int   @id @default(autoincrement())
  serviceOrderId Int
  partId         Int
  qty            Int   @default(1)
  unitPrice      Float @default(0)

  order ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  part  Part         @relation(fields: [partId], references: [id])

  @@unique([serviceOrderId, partId])
  @@index([serviceOrderId])
  @@index([partId])
}

// ==============================
// Header
// ==============================
model ServiceOrder {
  id         Int      @id @default(autoincrement())
  vehicleId  Int
  mechanicId Int?
  date       DateTime @default(now())
  odometer   Int?
  notes      String?

  items   ServiceItem[]
  parts   ServicePart[]

  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  mechanic Mechanic? @relation(fields: [mechanicId], references: [id])

  @@index([vehicleId])
  @@index([mechanicId])
  @@index([date])
}

// ==============================
// Auth/User
// ==============================
model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String
  role      Role     @default(PENELITI)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================
// Clustering
// ==============================
model ClusterRun {
  id        Int       @id @default(autoincrement())
  k         Int
  sse       Float
  createdAt DateTime  @default(now())

  centroids ClusterCentroid[]
  assigns   ClusterAssignment[]
}

model ClusterCentroid {
  id     Int   @id @default(autoincrement())
  runId  Int
  idx    Int   // index cluster
  c1     Float
  c2     Float
  c3     Float? // tambah kolom sesuai jumlah fitur

  run    ClusterRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, idx])  // ← tiap run, 1 centroid per idx
  @@index([idx])
}

model ClusterAssignment {
  id        Int   @id @default(autoincrement())
  runId     Int
  vehicleId Int
  idx       Int

  run       ClusterRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  vehicle   Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([runId, vehicleId]) // ← 1 kendaraan dapat 1 label per run
  @@index([runId])
  @@index([vehicleId])
  @@index([idx])
}
